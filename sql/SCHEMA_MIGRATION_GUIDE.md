# Schema Migration Guide: Insights Tables

## Current State

Your Supabase database has **TWO different insights tables** with different schemas:

### 1. `document_insights` (ACTIVE - In Production)
- **Status**: ✅ Actively used by Python backend
- **Location**: Created by Python code migrations
- **Frontend Status**: ✅ Updated to use this table

### 2. `project_insights` (PLANNED - Not Fully Implemented)
- **Status**: ⚠️ SQL schema exists but table may not be created
- **Location**: `/sql/11-project_insights_schema.sql`
- **Frontend Status**: ❌ Was initially targeting this table

## Key Schema Differences

| Field Purpose | `document_insights` (Actual) | `project_insights` (Planned) |
|--------------|------------------------------|------------------------------|
| Priority Level | `severity` (TEXT) | `priority` (ENUM) |
| Assignment | `assignee` (TEXT) | `assigned_to` (TEXT) |
| Status | `resolved` (BOOLEAN) | `status` (ENUM: open/in_progress/completed/cancelled) |
| Source | `doc_title` (TEXT) | `source_meeting_title` (TEXT) |
| Business Fields | ✅ Has business_impact, financial_impact, etc. | ❌ Missing |
| Arrays | ✅ stakeholders_affected, dependencies, exact_quotes | ✅ speakers, keywords, related_insights |

## Migration Options

### Option 1: Keep Using `document_insights` (RECOMMENDED ✅)

Since `document_insights` is already in production and working:

1. **No database changes needed**
2. **Frontend already updated** to use correct fields
3. **Python backend** continues working as-is

### Option 2: Migrate to `project_insights` Schema

If you want to use the planned schema:

```sql
-- 1. Create the project_insights table
source: /sql/11-project_insights_schema.sql

-- 2. Migrate data from document_insights
source: /sql/14-document_insights_actual.sql (see migration section)

-- 3. Update Python backend to use new table/fields
-- 4. Update frontend TypeScript types
```

### Option 3: Unify Both Tables

Use the provided `unified_insights` view:

```sql
-- Creates a view that combines both tables
source: /sql/14-document_insights_actual.sql (see VIEW section)
```

## Current Implementation Status

### ✅ Completed
- Frontend updated to use `document_insights` table
- Field mappings corrected (severity, assignee, resolved)
- TypeScript types generated from actual database
- Build successful and working

### ⚠️ Considerations
- Python backend expects `document_insights` table
- Changing to `project_insights` would require backend updates
- Some features may rely on business impact fields only in `document_insights`

## Recommendations

1. **Stay with `document_insights`** - It's working in production
2. **Document the decision** - Update README to clarify which table is used
3. **Clean up unused schemas** - Consider removing `project_insights` SQL if not needed
4. **Add missing fields** - If you need speakers/keywords, add them to `document_insights`:

```sql
-- Add missing fields to document_insights if needed
ALTER TABLE document_insights
ADD COLUMN IF NOT EXISTS speakers TEXT[],
ADD COLUMN IF NOT EXISTS keywords TEXT[];
```

## Quick Reference

### Frontend Code Uses
- Table: `document_insights`
- Priority field: `severity`
- Assignment field: `assignee`
- Status field: `resolved` (boolean)

### Python Backend Uses
- Table: `document_insights`
- All business impact fields
- Generated by: `ai_processor`

### SQL Files
- `/sql/11-project_insights_schema.sql` - Original planned schema
- `/sql/14-document_insights_actual.sql` - Actual production schema
- `/sql/12-automated_insights_triggers.sql` - Triggers for processing